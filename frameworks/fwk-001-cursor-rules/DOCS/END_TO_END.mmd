flowchart LR
%% ================== COLUMN/SUBGRAPH ===============

subgraph MEM[Knowledge / Memory Bridge]
  direction TB
  MEMAI[memory_ai]:::memory
  FMB[framework_memory_bridge]:::memory
end

subgraph ORCH[Orchestrator / Routing]
  direction TB
  RMT[rules_master_toggle]:::orch
  EXO[execution_orchestrator]:::orch
  RSJ[roles_status.json]:::index
  RMJ[routing_matrix.json]:::index
  WFJ[workflow_state.json]:::index
  GRJ[gate_results.json]:::index
  HJ[handoff_log.json]:::index
end

subgraph INP[Inputs]
  direction TB
  BLK[product_backlog.yaml]:::input
  ACT[Action_Plan.md]:::input
end

subgraph PLN[Planning & Design]
  direction TB
  PLAI[planning_ai]:::plan
  TP[technical_plan.md]:::plan
  TBK[task_breakdown.yaml]:::plan
  ADG[architecture_diagram.mermaid]:::plan
  ACJ[acceptance_criteria.json]:::plan
end

subgraph PREG[Audit/Validate/Synthesize Gates]
  direction TB
  AUD[auditor_ai]:::gate
  SR[Summary_Report.md]:::gate
  PE[principal_engineer_ai]:::gate
  VR[Validation_Report.md]:::gate
  FIP[Final_Implementation_Plan.md]:::gate
end

subgraph GOVZ[Governance & Extensions]
  direction TB
  SCH[artifact_schema.mdc]:::gov
  ROT[artifact_routing.mdc]:::gov
  SYN[artifact_sync_rules.mdc]:::gov
  HYD[hydration_rules.mdc]:::gov
  C1[framework_contract_framework1.mdc]:::gov
  C2[framework_contract_framework2.mdc]:::gov
  PRO[promotion_rules.mdc]:::gov
  AIJ[artifacts_index.json]:::index
end

subgraph SECZ[Security]
  direction TB
  AP[security/access_policies.md]:::sec
  ACL[security/acl.json]:::sec
  VAL[security/validate_security_config.py]:::sec
end

subgraph DEL[Delivery & Implementation]
  direction TB
  CG[codegen_ai]:::delivery
  QA[qa_ai]:::delivery
  DOC[documentation_ai]:::delivery
end

subgraph MZ[MLOps / Deploy]
  direction TB
  MLOP[mlops_ai]:::mlops
  DMF[deployment_manifest.yaml]:::index
end

subgraph OBSZ[Observability]
  direction TB
  OBSR[observability_ai]:::obs
  ANL[analyst_ai]:::obs
  MDASH[monitoring_dashboard.json]:::index
  AHL[alert_history.log]:::index
  HREP[health_report.md]:::index
end

MEMAI --> FMB
RMT --> EXO
RMT -- Routing JSON --- RMJ & RSJ
EXO --- WFJ & GRJ & HJ
PLAI --> TP & TBK & ADG & ACJ
AUD --> SR
PE --> VR
SR --> PE
VR --> FIP
SYN --- AIJ
VAL --- ACL
MLOP --- DMF
OBSR --- MDASH & AHL & HREP
ANL --- MDASH

RMJ -- "Route" --> PLAI & AUD & PE & CG & QA & MLOP & DOC & OBSR
BLK -- Input --> PLAI
ACT -- Input --> PLAI
TP -- Plan --> AUD & PE
TBK -- Plan --> AUD
ACJ -- Plan --> AUD
ADG -- Plan --> AUD
PLAI -- handoff --> SR
SR -- findings --> PE
VR -- confirmed findings --> FIP

SCH -. validates .- TP
ROT -. routes .- TP
SYN -. updates .- AIJ
HYD -. resolves inputs .- PLAI
AIJ -- "approved→latest→solo" --> HYD
HYD -- hydrated --> CG & QA & DOC & MLOP
PRO -. draft→approved→snapshot/rollback .- AIJ
PRO -. governs .- FIP
CG -- Implementation --> QA
QA --> MLOP
MLOP -- DeployNotify --> OBSR
DOC --> MLOP
ACL -- SecGate --> PRO & HYD & SYN
AP -. policy .- ACL
VAL -. validate .- ACL
FMB --- PLAI & CG & QA & DOC & MLOP

%% Enforcement mode
EXO --- EM1[AI_ENFORCEMENT_MODE=solo→WARN]:::index
EXO --- EM2[AI_ENFORCEMENT_MODE=team→BLOCK]:::index

%% ================== NODE STYLES (classDefs) ===============
classDef memory    fill:#FFF6E5,stroke:#F0B429,stroke-width:2px,color:#7A4D00
classDef orch      fill:#FFEBD6,stroke:#FF9D3B,stroke-width:2px,color:#8A4B00
classDef input     fill:#E8F5FF,stroke:#6BB6FF,stroke-width:2px,color:#0B5394
classDef plan      fill:#F0E6FF,stroke:#C5A3FF,stroke-width:2.5px,color:#5A2CA0
classDef gate      fill:#FFE5E5,stroke:#FF7A7A,stroke-width:2.2px,color:#A33
classDef gov       fill:#FFF0F5,stroke:#FF6FA1,stroke-width:2px,color:#8A004A
classDef delivery  fill:#E9FFE9,stroke:#66CC66,stroke-width:2px,color:#2F6627
classDef mlops     fill:#E6FFFA,stroke:#2DD4BF,stroke-width:2px,color:#065F46
classDef obs       fill:#EAF7FF,stroke:#62B0FF,stroke-width:2.3px,color:#0C4A6E
classDef sec       fill:#FFF0F5,stroke:#CC3366,stroke-width:2.3px,color:#8A0035
classDef index     fill:#FFFFFF,stroke:#333,stroke-dasharray: 6 3,stroke-width:1.5px,color:#333

%% ================== EDGE STYLES (linkStyle) ===============
linkStyle default stroke:#333,stroke-width:1.2px  %% Main/data flow is dark gray/black

%% Orange Routing lines (Orchestrator/RMJ to destinations)
linkStyle 13,14,15,16,17,18,19,20 stroke:#FF8800,stroke-width:2.2px

%% Sky blue input lines (Input to PLAI)
linkStyle 21,22 stroke:#6BB6FF,stroke-width:2px

%% Violet planning lines (PLAI to Planning artifacts)
linkStyle 7,8,9,10 stroke:#5A2CA0,stroke-width:2.2px

%% Red/pink lines (Gates)
linkStyle 28,29,30,31,32,33,34,35 stroke:#A33,stroke-width:2.2px

%% Governance enforcement lines (dotted gray)
linkStyle 36,37,38,39 stroke:#999,stroke-width:2px,stroke-dasharray:4 3

%% Hydration (green thin)
linkStyle 40,41,42,43 stroke:#2E8B57,stroke-width:1.5px

%% Promo/snapshot dotted blue
linkStyle 44,45 stroke:#0077CC,stroke-dasharray:4 3

%% Security lines
linkStyle 46,47,48 stroke:#8A0035,stroke-width:1.4px
linkStyle 49,50 stroke:#8A0035,stroke-width:2.2px,stroke-dasharray:4 3

%% Memory bridge lines (amber)
linkStyle 51,52,53,54,55 stroke:#F0B429,stroke-width:1.8px
flowchart TD
  %% Inputs → Artifacts → Governance/Promotion → Observability

  subgraph Inputs
    PO[/Backlog: product_backlog.yaml/]
    AP[/Action_Plan.md/]
  end

  subgraph Planning
    PL[planning_ai]
    TPL[[technical_plan.md]]
    TBD[[task_breakdown.yaml]]
    ADG[[architecture_diagram.mermaid]]
  end

  subgraph Audit_Verify_Synthesize
    AU[auditor_ai]
    SR[[Summary_Report.md]]
    PE[principal_engineer_ai]
    VR[[Validation_Report.md]]
    FIP[[Final_Implementation_Plan.md]]
  end

  subgraph Delivery
    CG[codegen_ai]
    QA[qa_ai]
    ML[mlops_ai]
    DOC[documentation_ai]
  end

  subgraph Observability
    OB[observability_ai]
    AN[analyst_ai]
  end

  subgraph Memory_Bridge
    MEM[memory_ai]
    BRIDGE[[framework_memory_bridge]]
  end

  subgraph Orchestration
    ORCH[execution_orchestrator]
    RMT[rules_master_toggle]
  end

  %% Origin/main additions (contracts, routing, promotion, sync)
  subgraph Governance_and_Extensions
    CNT[[contracts/*]]
    GOV[[governance/*]]
    ROUTE[[routing/*]]
    PROMO[[promotion/*]]
    SYNC[[sync/*]]
    SCHEMA[[schemas/*]]
    SEC[[security/*]]
  end

  %% Flow wiring
  PO --> PL
  AP --> PL
  PL --> TPL --> AU --> SR --> PE --> VR --> FIP --> CG
  PL --> TBD
  CG --> QA --> ML --> OB --> AN
  CG --> DOC
  MEM --- BRIDGE --- ORCH
  ORCH --> PL
  ORCH --> CG
  ORCH --> QA
  ORCH --> ML
  RMT --> ORCH

  %% Governance hooks
  TPL --> CNT
  FIP --> GOV
  ROUTE -. artifact routing .- DOC
  PROMO -. release process .- ML
  SYNC -. index & concurrency .- GOV
  SCHEMA --> ROUTE
  SEC --> ML

  %% Inputs to Observability
  ML --> OB
  OB --> AN

  %% Final Outputs
  AN -->|reports| GOV
